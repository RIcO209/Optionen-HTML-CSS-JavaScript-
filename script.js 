const grid = document.getElementById('game-grid');
const scoreDisplay = document.getElementById('score');
const rows = 20;
const cols = 10;
let score = 0;

// Create grid
const cells = [];
for (let r = 0; r < rows; r++) {
  for (let c = 0; c < cols; c++) {
    const cell = document.createElement('div');
    grid.appendChild(cell);
    cells.push(cell);
  }
}

// Tetrimino shapes
const shapes = [
  [1, cols + 1, cols * 2 + 1, 2], // L-shape
  [0, 1, cols, cols + 1],        // Square
  [1, cols, cols + 1, cols + 2], // T-shape
  [0, 1, cols + 1, cols + 2],    // Z-shape
  [1, cols + 1, cols * 2 + 1, cols * 3 + 1], // I-shape
];

// Current state
let currentPosition = 4;
let currentShape = shapes[Math.floor(Math.random() * shapes.length)];

// Draw tetrimino
function draw() {
  currentShape.forEach(index => {
    cells[currentPosition + index].classList.add('active');
    cells[currentPosition + index].style.background = '#f39c12';
  });
}

// Undraw tetrimino
function undraw() {
  currentShape.forEach(index => {
    cells[currentPosition + index].classList.remove('active');
    cells[currentPosition + index].style.background = '#444';
  });
}

// Move down
function moveDown() {
  undraw();
  currentPosition += cols;
  draw();
  freeze();
}

// Freeze tetrimino
function freeze() {
  if (currentShape.some(index => cells[currentPosition + index + cols]?.classList.contains('taken'))) {
    currentShape.forEach(index => cells[currentPosition + index].classList.add('taken'));
    currentShape = shapes[Math.floor(Math.random() * shapes.length)];
    currentPosition = 4;
    draw();
    checkRow();
  }
}

// Check and clear full rows
function checkRow() {
  for (let r = 0; r < rows; r++) {
    const row = Array.from({ length: cols }, (_, i) => r * cols + i);
    if (row.every(index => cells[index].classList.contains('taken'))) {
      row.forEach(index => {
        cells[index].classList.remove('taken', 'active');
        cells[index].style.background = '#444';
      });
      const removed = cells.splice(r * cols, cols);
      grid.prepend(...removed);
      score += 10;
      scoreDisplay.textContent = `Score: ${score}`;
    }
  }
}

// Controls
function control(e) {
  if (e.key === 'ArrowLeft') moveLeft();
  if (e.key === 'ArrowRight') moveRight();
  if (e.key === 'ArrowDown') moveDown();
}

function moveLeft() {
  undraw();
  if (!currentShape.some(index => (currentPosition + index) % cols === 0)) {
    currentPosition -= 1;
  }
  if (currentShape.some(index => cells[currentPosition + index]?.classList.contains('taken'))) {
    currentPosition += 1;
  }
  draw();
}

function moveRight() {
  undraw();
  if (!currentShape.some(index => (currentPosition + index) % cols === cols - 1)) {
    currentPosition += 1;
  }
  if (currentShape.some(index => cells[currentPosition + index]?.classList.contains('taken'))) {
    currentPosition -= 1;
  }
  draw();
}

document.addEventListener('keydown', control);
draw();
setInterval(moveDown, 1000);
